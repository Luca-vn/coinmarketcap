<!DOCTYPE html>
<html>
<head>
    <title>Bot Action Chart - {{ asset.upper() }}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h2>Biá»ƒu Ä‘á»“ Bot Action: {{ asset.upper() }}</h2>
    <canvas id="botChart" width="1000" height="400"></canvas>

    <script>
        const labels = {{ timestamps|tojson }};
        const priceData = {{ price_pct|tojson }};
        const volumeData = {{ volume_pct|tojson }};
        const botActions = {{ bot_actions|default([], true)|tojson }};
        const prices = {{ prices|default([], true)|tojson }};
        const annotations = {{ annotations|default([], true)|tojson }};

        const pointStyles = [];
        const pointColors = [];

        let countGom = 0, countXa = 0, countGomAm = 0, countXaAm = 0;
        let countTrap = 0, countTrapShort = 0, countTrapLong = 0;

        botActions.forEach(action => {
            if (action.includes("ðŸ”µ")) {
                pointStyles.push("triangle"); pointColors.push("blue"); countGom++;
            } else if (action.includes("ðŸ”´")) {
                pointStyles.push("triangle"); pointColors.push("red"); countXa++;
            } else if (action.includes("ðŸŸ¡")) {
                pointStyles.push("triangle"); pointColors.push("gold"); countGomAm++;
            } else if (action.includes("ðŸ–¤")) {
                pointStyles.push("triangle"); pointColors.push("black"); countXaAm++;
            } else if (action.includes("Trap")) {
                pointStyles.push("triangle"); pointColors.push("deeppink"); countTrap++;
                if (action.includes("ðŸ“‰")) countTrapLong++;
                if (action.includes("ðŸ“ˆ")) countTrapShort++;
            } else {
                pointStyles.push("circle");
                pointColors.push("rgba(0,0,0,0)");
            }
        });

        const ctx = document.getElementById('botChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '% Price Change',
                        data: priceData,
                        borderColor: 'blue',
                        tension: 0.1,
                        pointStyle: pointStyles,
                        pointRadius: 8,
                        pointBackgroundColor: pointColors
                    },
                    {
                        label: '% Volume Change',
                        data: volumeData,
                        borderColor: 'orange',
                        tension: 0.1,
                        borderDash: [5, 5],
                        pointRadius: 3
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    tooltip: {
                        callbacks: {
                            afterBody: function(context) {
                                let i = context[0].dataIndex;
                                return 'Bot: ' + (botActions[i] || 'KhÃ´ng rÃµ') + '\nGiÃ¡: ' + (prices[i] || '-') + ' USDT';
                            }
                        }
                    },
                    legend: { position: 'top' },
                    title: {
                        display: true,
                        text: 'PhÃ¢n tÃ­ch hÃ nh vi bot: {{ asset.upper() }}'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: '% Thay Ä‘á»•i'
                        }
                    }
                }
            }
        });

        // ðŸ“Š Hiá»ƒn thá»‹ thá»‘ng kÃª
        document.write("<div style='margin-top:20px;'>");
        document.write("<h3>ðŸ“Š Thá»‘ng kÃª hÃ nh vi bot</h3>");
        document.write("<ul>");
        document.write("<li><span style='color:blue;'>ðŸ”µ Gom máº¡nh</span>: " + countGom + " láº§n</li>");
        document.write("<li><span style='color:red;'>ðŸ”´ Xáº£ máº¡nh</span>: " + countXa + " láº§n</li>");
        document.write("<li><span style='color:gold;'>ðŸŸ¡ Gom Ã¢m tháº§m</span>: " + countGomAm + " láº§n</li>");
        document.write("<li><span style='color:black;'>ðŸ–¤ Xáº£ Ã¢m tháº§m</span>: " + countXaAm + " láº§n</li>");
        document.write("<li><span style='color:deeppink;'>ðŸ“‹ Trap</span>: " + countTrap + " láº§n</li>");
        document.write("<li>ðŸ“ˆ Trap Short: " + countTrapShort + " láº§n</li>");
        document.write("<li>ðŸ“‰ Trap Long: " + countTrapLong + " láº§n</li>");
        document.write("</ul></div>");

        // ðŸ—‚ï¸ VÃ¹ng giÃ¡ hÃ nh vi bot
        if (annotations.length > 0) {
            document.write("<div style='margin-top:20px;'>");
            document.write("<h3>ðŸ“‹ Danh sÃ¡ch vÃ¹ng giÃ¡ hÃ nh vi bot</h3>");
            document.write("<table border='1' cellpadding='5'><tr><th>Loáº¡i</th><th>Báº¯t Ä‘áº§u</th><th>Káº¿t thÃºc</th><th>GiÃ¡</th></tr>");
            annotations.forEach(a => {
                const parts = a.label.content.split("@");
                const type = parts[0].trim();
                const price = parts[1] ? parts[1].trim() : "-";
                document.write("<tr><td>" + type + "</td><td>" + a.xMin + "</td><td>" + a.xMax + "</td><td>" + price + "</td></tr>");
            });
            document.write("</table></div>");
        }
    </script>
</body>
</html>