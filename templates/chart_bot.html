<!DOCTYPE html>
<html>
<head>
    <title>Bot Action Chart - {{ asset.upper() }}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h2>Biểu đồ Bot Action: {{ asset.upper() }}</h2>
    <canvas id="botChart" width="1000" height="400"></canvas>

    <script>
        const labels = {{ timestamps|tojson }};
        const priceData = {{ price_pct|tojson }};
        const volumeData = {{ volume_pct|tojson }};
        const botActions = {{ bot_actions|default([], true)|tojson }};
        const prices = {{ prices|default([], true)|tojson }};
        const annotations = {{ annotations|default([], true)|tojson }};

        const pointStyles = [];
        const pointColors = [];

        let countGom = 0, countXa = 0, countGomAm = 0, countXaAm = 0;
        let countTrap = 0, countTrapShort = 0, countTrapLong = 0;

        botActions.forEach(action => {
            if (action.includes("🔵")) {
                pointStyles.push("triangle"); pointColors.push("blue"); countGom++;
            } else if (action.includes("🔴")) {
                pointStyles.push("triangle"); pointColors.push("red"); countXa++;
            } else if (action.includes("🟡")) {
                pointStyles.push("triangle"); pointColors.push("gold"); countGomAm++;
            } else if (action.includes("🖤")) {
                pointStyles.push("triangle"); pointColors.push("black"); countXaAm++;
            } else if (action.includes("Trap")) {
                pointStyles.push("triangle"); pointColors.push("deeppink"); countTrap++;
                if (action.includes("📉")) countTrapLong++;
                if (action.includes("📈")) countTrapShort++;
            } else {
                pointStyles.push("circle");
                pointColors.push("rgba(0,0,0,0)");
            }
        });

        const ctx = document.getElementById('botChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '% Price Change',
                        data: priceData,
                        borderColor: 'blue',
                        tension: 0.1,
                        pointStyle: pointStyles,
                        pointRadius: 8,
                        pointBackgroundColor: pointColors
                    },
                    {
                        label: '% Volume Change',
                        data: volumeData,
                        borderColor: 'orange',
                        tension: 0.1,
                        borderDash: [5, 5],
                        pointRadius: 3
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    tooltip: {
                        callbacks: {
                            afterBody: function(context) {
                                let i = context[0].dataIndex;
                                return 'Bot: ' + (botActions[i] || 'Không rõ') + '\nGiá: ' + (prices[i] || '-') + ' USDT';
                            }
                        }
                    },
                    legend: { position: 'top' },
                    title: {
                        display: true,
                        text: 'Phân tích hành vi bot: {{ asset.upper() }}'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: '% Thay đổi'
                        }
                    }
                }
            }
        });

        // 📊 Hiển thị thống kê
        document.write("<div style='margin-top:20px;'>");
        document.write("<h3>📊 Thống kê hành vi bot</h3>");
        document.write("<ul>");
        document.write("<li><span style='color:blue;'>🔵 Gom mạnh</span>: " + countGom + " lần</li>");
        document.write("<li><span style='color:red;'>🔴 Xả mạnh</span>: " + countXa + " lần</li>");
        document.write("<li><span style='color:gold;'>🟡 Gom âm thầm</span>: " + countGomAm + " lần</li>");
        document.write("<li><span style='color:black;'>🖤 Xả âm thầm</span>: " + countXaAm + " lần</li>");
        document.write("<li><span style='color:deeppink;'>📋 Trap</span>: " + countTrap + " lần</li>");
        document.write("<li>📈 Trap Short: " + countTrapShort + " lần</li>");
        document.write("<li>📉 Trap Long: " + countTrapLong + " lần</li>");
        document.write("</ul></div>");

        // 🗂️ Vùng giá hành vi bot
        if (annotations.length > 0) {
            document.write("<div style='margin-top:20px;'>");
            document.write("<h3>📋 Danh sách vùng giá hành vi bot</h3>");
            document.write("<table border='1' cellpadding='5'><tr><th>Loại</th><th>Bắt đầu</th><th>Kết thúc</th><th>Giá</th></tr>");
            annotations.forEach(a => {
                const parts = a.label.content.split("@");
                const type = parts[0].trim();
                const price = parts[1] ? parts[1].trim() : "-";
                document.write("<tr><td>" + type + "</td><td>" + a.xMin + "</td><td>" + a.xMax + "</td><td>" + price + "</td></tr>");
            });
            document.write("</table></div>");
        }
    </script>
</body>
</html>