<!DOCTYPE html>
<html>
<head>
    <title>Bot Action Chart - {{ asset.upper() }}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.1.0"></script>
</head>
<body>
    <h2>Bi·ªÉu ƒë·ªì Bot Action: {{ asset.upper() }}</h2>
    <canvas id="botChart" width="1000" height="400"></canvas>

    <script>
        const labels = {{ timestamps|tojson }};
        const priceData = {{ price_pct|tojson }};
        const volumeData = {{ volume_pct|tojson }};
        const botActions = {{ bot_actions|default([], true)|tojson }};
        const prices = {{ prices|default([], true)|tojson }};
        const annotations = {{ annotations|default([], true)|tojson }};
        const pointStyles = [];
        const pointColors = [];

        let countGom = 0, countXa = 0, countGomAm = 0, countXaAm = 0, countTrap = 0;

        botActions.forEach(action => {
            if (action.includes("üîµ")) {
                pointStyles.push("triangle");
                pointColors.push("blue");
                countGom++;
            } else if (action.includes("üî¥")) {
                pointStyles.push("triangle");
                pointColors.push("red");
                countXa++;
            } else if (action.includes("üü°")) {
                pointStyles.push("triangle");
                pointColors.push("gold");
                countGomAm++;
            } else if (action.includes("üñ§")) {
                pointStyles.push("triangle");
                pointColors.push("black");
                countXaAm++;
            } else if (action.includes("üìã")) {
                pointStyles.push("triangle");
                pointColors.push("deeppink");
                countTrap++;
            } else {
                pointStyles.push("circle");
                pointColors.push("rgba(0,0,0,0)");
            }
        });

        const ctx = document.getElementById('botChart').getContext('2d');
        const botChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '% Price Change',
                        data: priceData,
                        borderColor: 'blue',
                        backgroundColor: 'blue',
                        tension: 0.1,
                        pointStyle: pointStyles,
                        pointRadius: 10,
                        pointHoverRadius: 12,
                        pointBackgroundColor: pointColors
                    },
                    {
                        label: '% Volume Change',
                        data: volumeData,
                        borderColor: 'orange',
                        backgroundColor: 'orange',
                        tension: 0.1,
                        borderDash: [5, 5],
                        pointRadius: 3
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    tooltip: {
                        callbacks: {
                            afterBody: function(context) {
                                let index = context[0].dataIndex;
                                return 'Bot Action: ' + (botActions[index] || 'Kh√¥ng r√µ') + '\nGi√°: ' + (prices[index] || '-') + ' USDT';
                            }
                        }
                    },
                    legend: {
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: 'Ph√¢n t√≠ch h√†nh vi bot: {{ asset.upper() }}'
                    },
                    annotation: {
                        annotations: {} // üîï T·∫Øt overlay ƒë·ªÉ kh√¥ng r·ªëi bi·ªÉu ƒë·ªì
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: '% Change'
                        }
                    }
                }
            }
        });

        // ‚úÖ Hi·ªÉn th·ªã th·ªëng k√™
        document.write("<div style='margin-top:20px;'>");
        document.write("<b>Th·ªëng k√™ h√†nh vi bot:</b><br>");
        document.write("<span style='color:blue;'>üîµ Gom m·∫°nh</span>: " + countGom + " l·∫ßn<br>");
        document.write("<span style='color:red;'>üî¥ X·∫£ m·∫°nh</span>: " + countXa + " l·∫ßn<br>");
        document.write("<span style='color:gold;'>üü° Gom √¢m th·∫ßm</span>: " + countGomAm + " l·∫ßn<br>");
        document.write("<span style='color:black;'>üñ§ X·∫£ √¢m th·∫ßm</span>: " + countXaAm + " l·∫ßn<br>");
        document.write("<span style='color:deeppink;'>üìã Trap</span>: " + countTrap + " l·∫ßn<br>");
        document.write("</div>");

        // ‚úÖ Hi·ªÉn th·ªã b·∫£ng v√πng gi√° b√™n d∆∞·ªõi bi·ªÉu ƒë·ªì
        document.write("<div style='margin-top:20px;'>");
        document.write("<h3>üìã Danh s√°ch v√πng gi√° h√†nh vi bot</h3>");
        document.write("<table border='1' cellpadding='5'><tr><th>Lo·∫°i</th><th>Th·ªùi gian b·∫Øt ƒë·∫ßu</th><th>Th·ªùi gian k·∫øt th√∫c</th><th>Gi√°</th></tr>");
        annotations.forEach(a => {
            let parts = a.label.content.split("@");
            let type = parts[0].trim();
            let price = parts[1] ? parts[1].trim() : "-";
            document.write("<tr><td>" + type + "</td><td>" + a.xMin + "</td><td>" + a.xMax + "</td><td>" + price + "</td></tr>");
        });
        document.write("</table></div>");
    </script>
</body>
</html>
